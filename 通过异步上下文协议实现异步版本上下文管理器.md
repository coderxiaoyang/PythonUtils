我们知道在同步逻辑中想要实现一个上下文管理器只要实现`__enter__`和`__exit__`两个上下文协议就好了。

在异步逻辑中需要实现上下文管理器是通过异步的上下文协议来实现的:`__aenter__`和`__aexit__`。

这两个函数的作用和含义和同步版一致，只是方法已经改为了异步方法。

```python
class AsyncContextManager:
    """
    异步上下文资源管理器
    子类通过实现_context_release接口，方便的实现with语句管理上下文资源释放
    """

    async def __aenter__(self):

        await self._context_initialize()

        return self

    async def __aexit__(self, exc_type, exc_value, traceback):

        await self._context_release()

        # 记录日志 或者 通过返回False 抛出异常
        return True

    async def _context_initialize(self):
        """
        进入上下文管理器的时候 我们可以做一些事情
        """

        pass

    async def _context_release(self):
        """
        退出上下文管理器的时候 我们也可以做一些事情 比如关闭文件句柄等
        """

        raise NotImplementedError()

```

异步上下文管理器的使用是: `async with ... as ...`

**关于上下文管理器中的异常**

如果发生异常，Python会将异常的`type`,`value`和`traceback`传递给__exit__方法。
它让`__exit__`方法来决定如何关闭文件以及是否需要其他步骤。

我们来列一下，当异常发生时，with语句会采取哪些步骤。

1. 它把异常的type,value和traceback传递给`__exit__`方法
2. 它让`__exit__`方法来处理异常
3. 如果`__exit__`返回的是True，那么这个异常就被优雅地处理了。
4. 如果`__exit__`返回的是True以外的任何东西，那么这个异常将被with语句抛出。


<div  style="text-align: center;">    
<img src="https://s1.ax1x.com/2020/06/25/NwjAbj.jpg" alt="求微信赞赏" border="0"  width="230" height="230" />
<img src="https://s1.ax1x.com/2020/06/25/NwjvyF.jpg" alt="求支付宝赞赏" border="0"  width="230" height="230"/>
<img src="https://s1.ax1x.com/2020/06/25/Nwv8l8.jpg" alt="加微信好友" border="0" width="230" height="230"/>
</div>

> 如果您觉得此文对您有帮助 可以选择微信或支付宝支持我一下或者加我微信好友 一起搞py交易
